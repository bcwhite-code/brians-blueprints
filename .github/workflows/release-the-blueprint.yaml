name: Release the blueprint

on:
  push:
    tags:
      - "*"

permissions: read-all

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Determine variables
        id: determine-variables
        run: |
          folder=${GITHUB_REF#*/tags/}
          folder=${folder%-*}
          version=${GITHUB_REF##*/}
          version=${version//[!0-9.]/}

          release_name=$(echo "${folder//-/ }" | sed -e 's/\b\(.\)/\u\1/g')
          release_name="$release_name $version"

          echo "folder=$folder" >>$GITHUB_OUTPUT
          echo "version=$version" >>$GITHUB_OUTPUT
          echo "release_name=$release_name" >>$GITHUB_OUTPUT

      - name: build
        run: python3 tools/fatul.py encode -v ${{ steps.determine-variables.outputs.folder }}/book ${{ steps.determine-variables.outputs.folder }}-${{ steps.determine-variables.outputs.version }}.txt
      - name: release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.determine-variables.outputs.folder }}-${{ steps.determine-variables.outputs.version }}.txt
          fail_on_unmatched_files: true
          body: |
            The blueprint book contains "blocks" to build everything from coal-fired smelters to 10GW nuclear reactors to 360 science-per-minute rocket launchers.
            Read more at https://github.com/bcwhite-code/brians-blueprints/tree/main/${{ steps.determine-variables.outputs.folder }}/README.md
            Changelog: https://github.com/bcwhite-code/brians-blueprints/tree/main/${{ steps.determine-variables.outputs.folder }}/CHANGELOG.md
          name: ${{ steps.determine-variables.outputs.release_name}}
